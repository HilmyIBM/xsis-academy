<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{fragments/layoutOrder}"
>
  <head>
    <title>Order::Catalog</title>
  </head>
  <body>
    <div layout:fragment="content">

        <div class="card">
            <div class="card-header h3" th:text="${title}"></div>
            <div class="card-body">
                <div class="row" >
                        <div class="col">
                            <div class="card bg-info">
                                <div class="card-body text-center text-white">
                                    <div class="h1" id="totProduct">0</div>
                                    <div class="h5">Total Product</div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card bg-warning">
                                <div class="card-body text-center">
                                    <div class="h1" id="estPrice">0</div>
                                    <div class="h5">Estimated Price</div>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card bg-success">
                                <div class="card-body text-center text-white">
                                    <div class="h1"><i class="fas fa-cart-plus"></i></div>
                                    <button id="addToCart" class="btn stretched-link p-0 text-white">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="row p-5 g-2">
                    <div class="col-lg-3 col-sm-12" th:if="${products != null}" th:each="product : ${products}">
                        <div class="card h-100 d-flex flex-column">
                            <img th:src="@{'lib/images/'+${product.image}}" class="card-img-top img-fluid" style="height: 200px; object-fit: cover;">
                            <div class="card-header h5 text-truncate" id="" th:text="${product.name}">Product 1</div>
                            <div class="card-body">
                                <div class="card-text d-flex justify-content-between">
                                    <span>Price: </span>
                                    <span id="price-" th:text="${product.price}" data-price="">99.999,-</span>
                                </div>
                                <div class="card-text d-flex justify-content-between">
                                    <span>Stock: </span>
                                    <span id="stock-" th:text="${product.stock}" data-stock="">99</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify content between">
                                    <div class="btn-group">
                                        <button class="btn btn-danger" id="btnRemove-"><i class="fas fa-minus"></i></button>
                                        <input type="text" class="form-control text-center" id="qty-" value=0 readonly>
                                        <button class="btn btn-success" id="btnAdd-"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:unless="${products != null}">
                        <div class="text text-center text-danger">Data is empty</div>
                    </div>
                </div>
            </div>
        </div>

      <script th:inline="javascript">
        let listCart=[];

        $(document).ready(function(e){
            let totProduct = $("{#totProduct}").text();
            let estPrice = $("{#estPrice}").text();

            //prepare empty product
            let product = {};

            $(".btn-danger").click(function(e){
                let productId = $(this).data("id");
                let productName = $("#name-" + productId).data("id");
                let productQty = parseInt($("#qty-" + productId).val());
                let productPrice = parseFloat($("#price-" + productId).data("price"));
                let productStock = parseFloat($("#stock-" + productId).data("stock"));

                if (productQty > 0){
                    productStock++;
                    totProduct--;
                    productQty--;
                    estPrice-=productPrice;

                    let productCartIdx = listCart.map(p=>p,productId).indexOf(productId);

                    if (productCartIdx >=0){
                        listCart[productCartIdx].Qty  =[productQty];
                    }

                    if (productCartIdx < 1){
                        listCart.splice(productCartIdx, 1);
                    }

                    //update ui
                    $("#totProduct").text(totProduct);
                    $("#estPrice").text(estPrice);
                    $("#qty-"+productId).val(productQty);
                    $("#stock-"+productId).data("stock");
                }
                
            });

        })
      </script>
    </div>
  </body>
</html>

