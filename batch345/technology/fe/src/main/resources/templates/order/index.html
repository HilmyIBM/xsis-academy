<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{fragments/layoutOrder}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order::Catalog</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="card">
            <div class="card-header h3" th:text="${title}"></div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col">
                        <div class="card bg-primary">
                            <div class="card-body text-center text-white">
                                <div class="h1" id="totalProduct">0</div>
                                <div class="h5">Total Items</div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card bg-warning">
                            <div class="card-body text-center">
                                <div class="h1" id="estPrice">0</div>
                                <div class="h5">Estimated Price</div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card bg-success">
                            <div class="card-body text-center text-white">
                                <div class="h1"><i class="fas fa-cart-plus"></i></div>
                                <button id="addToCart" class="btn stretched-link p-0 text-white" disabled><h5 class="m-0">Add to Cart</h5></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div th:if="${products != null}" th:each="product:${products}" class="col-lg-3 col-sm-12">
                        <div class="card">
                            <div style="width: 100%; height:300px; overflow: hidden; display: block;">
                                <img class="card-img-top img-thumbnail" th:if="${product.image != null}" th:src="@{/assets/img/{imageName}(imageName=${product.image})}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                                <img class="card-img-top img-thumbnail" th:unless="${product.image != null}" src="assets/img/default.png" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div class="card-header h5 text-truncate" th:id="|name-${product.id}|" th:text="${product.name}"> Product 1</div>
                            <div class="card-body">
                                <div class="card-text d-flex justify-content-between">
                                    <span>Price : </span><span th:id="|price-${product.id}|" th:text="${product.price}" th:data-price="${product.price}">Rp. 15000</span>
                                </div>
                                <div class="card-text d-flex justify-content-between">
                                    <span>Stock : </span><span th:id="|stock-${product.id}|" th:text="${product.stock}" th:data-stock="${product.stock}">99</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <div class="btn-group">
                                        <button class="btn btn-danger btnRemove" th:id="|btnRemove-${product.id}|" th:data-id="${product.id}" disabled="true"><i class="fas fa-minus"></i></button>
                                        <input type="text" class="form-control text-center" th:id="|qty-${product.id}|" value="0">
                                        <button class="btn btn-success btnAdd" th:id="|btnAdd-${product.id}|" th:data-id="${product.id}"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div th:unless="${products != null}" th:text="${'Tidak Ada Product'}" class="text-center text-danger fst-italic"></div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let listCart = [];
            $(document).ready(function(e){
                let totalProduct = parseInt($("#totalProduct").text());
                let estPrice = parseFloat($("#estPrice").text());

                $(".btnAdd").click(function(e){
                    let productId = $(this).data("id");
                    let productName = $("#name-" + productId).text();
                    let productQty = parseInt($("#qty-" + productId).val());
                    let productPrice = parseFloat($("#price-" + productId).data("price"));
                    let productStock = parseFloat($("#stock-" + productId).data("stock"));

                    // Prepare Empty Product
                    let product = {};

                    if (productStock > 0) {
                        productStock--;
                        totalProduct++;
                        productQty++;
                        estPrice += productPrice

                        // Input value as product properties
                        product.id = productId;
                        product.productName = productName;
                        product.price = productPrice;
                        product.qty = productQty;

                        // Check if product already exists in cart by its id
                        let productCartIdx = listCart.map(p => p.id).indexOf(productId);

                        // Update List Cart
                        if (productCartIdx < 0) {
                            listCart.push(product);
                        } else {
                            listCart[productCartIdx].qty = productQty;
                        }

                        // Update UI
                        $("#totalProduct").text(totalProduct);
                        $("#estPrice").text(estPrice);
                        $("#qty-" + productId).val(productQty);
                        $("#stock-" + productId).data("stock", productStock);
                        $("#stock-" + productId).text(productStock);
                    }

                    // Deactive Add Product Button if Stock is empty 
                    if (productStock < 1) {
                        $(this).prop("disabled", true);
                    }

                    // Activate Remove Product Button
                    if (productQty > 0) {
                        $("#btnRemove-" + productId).prop("disabled", false);
                    }

                    // Activa add to Cart Button when ListCart is not Empty
                    if (listCart.length > 0) {
                        $("#addToCart").prop("disabled", false);
                    }
                    
                    console.log(listCart);
                })

                $(".btnRemove").click(function(e){
                    let productId = $(this).data("id");
                    let productName = $("#name-" + productId).text();
                    let productQty = parseInt($("#qty-" + productId).val());
                    let productPrice = parseFloat($("#price-" + productId).data("price"));
                    let productStock = parseFloat($("#stock-" + productId).data("stock"));
                    if(productQty > 0){
                        productStock++;
                        totalProduct--;
                        productQty--;
                        estPrice -= productPrice;

                        let productCartIdx = listCart.map(p => p.id).indexOf(productId);
                        if(productCartIdx >= 0){
                            listCart[productCartIdx].qty = productQty;
                        }

                        if (listCart[productCartIdx].qty < 1) {
                            listCart.splice(productCartIdx, 1);
                        }

                        // Update UI
                        $("#totalProduct").text(totalProduct);
                        $("#estPrice").text(estPrice);
                        $("#qty-" + productId).val(productQty);
                        $("#stock-" + productId).data("stock", productStock);
                        $("#stock-" + productId).text(productStock);
                    }

                    if(productQty < 1){
                        $(this).prop("disabled", true);
                    }

                    if(productStock > 0){
                        $("#btnAdd-" + productId).prop("disabled", false);
                    }

                    // Deactive add to Cart Button when ListCart is Empty
                    if (listCart.length < 1) {
                        $("#addToCart").prop("disabled", true);
                    }

                    console.log(listCart);
                });
            
                $("#addToCart").click(function(e){
                    $("#staticModalLg").load(
                        "/order/cart",
                        {
                            "listCart": listCart,
                            "totalProduct": totalProduct,
                            "estPrice": estPrice
                        },
                        function(result, status) {
                            if(status == "success"){
                                $("#staticModalLg").modal("show");
                            }else{
                                alert("Salah");
                                console.error("status", status);
                                console.error("result", result);
                            }
                        }
                    );
                })
            })
        </script>
    </div>
</body>
</html>