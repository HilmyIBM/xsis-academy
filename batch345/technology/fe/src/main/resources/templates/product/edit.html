<span th:text="${title}" class="d-none" id="txtTitle"></span>
<div class="card-body">
    <form id="frmEditProduct" enctype="multipart/form-data">
        <input type="number" name="updateBy" value="100" hidden>
        <!-- simpan gambar sebelumnya jika tidak diUpdate -->
        <input type="hidden" name="image" th:value="${product.image}">
        <input type="number" id="categoryId" name="categoryId" th:value="${product.categoryId}" hidden>
        <!-- Image Preview Section -->
        <div th:if="${product.image != null}" id="imagePreview" class="d-flex justify-content-center">
            <div class="ratio ratio-1x1" style="width: 250px; border-radius: 25px;">
                <img th:src="@{'lib/images/'+${product.image}}" alt="Image Preview" style="object-fit: cover" />
            </div>
        </div>
        <div class="mb-3">
            <label for="inputImageProduct" class="form-label">Upload Image</label>
            <input type="file" id="inputImageProduct" name="myImage" class="form-control"
                accept="image/png, image/jpeg, image/jpg" th:value="${product.image}">
            <!-- Span to show selected image file name -->
            <span id="fileName" class="text-muted" style="display:none;">No file selected</span>
            <!-- Error message for invalid files -->
            <span id="fileError" class="text-danger d-none"></span>
        </div>

        <div class="mb-3">
            <label for="txtNameProduct" class="form-label">Nama Product</label>
            <input type="text" name="name" id="txtNameProduct" class="form-control" th:value="${product.name}" required>
        </div>

        <div class="mb-3">
            <label for="txtPrice" class="form-label">Price</label>
            <input type="number" name="price" id="txtPrice" class="form-control" th:value="${product.price}" required>
        </div>

        <div class="mb-3">
            <label for="txtStock" class="form-label">Stock</label>
            <input type="number" name="stock" id="txtStock" class="form-control" th:value="${product.stock}" required>
        </div>
        <div class="form-group container-group">
            <label for="myVariantId" class="form-label">Variant</label>
            <!-- Example of dynamic population -->
            <select name="variantId" id="myVariantId" class="form-select" th:attr="data-selected=${product.variantId}">
                <option value="">-- Select Variant --</option>
            </select>
        </div>
        <div class="d-flex flex-row-reverse">
            <button type="submit" class="btn btn-success">Save</button>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
        $("#staticModalLabel").text($("#txtTitle").text())

        // Preview selected image
        // Preview selected image
        const allowedExtensions = /\.(jpg|jpeg|png)$/i;
        $("#inputImageProduct").on("change", function () {
            const file = this.files[0];
            const errorElement = $("#fileError");
            const previewContainer = $("#imagePreview");
            const previewImage = $("#imagePreview img");

            if (file) {
                // Check if the file has a valid image extension
                if (!allowedExtensions.test(file.name)) {
                    errorElement
                        .removeClass("d-none")
                        .text("Please upload a valid image file (JPEG or PNG only).");
                    $(this).val(""); // Clear the file input
                    previewContainer.addClass("d-none"); // Hide the preview container
                    previewImage.attr("src", "#"); // Clear the image source
                    return;
                }

                // If the file is valid, hide the error message
                errorElement.addClass("d-none").text("");

                // Use FileReader to read the selected file and display it as a preview
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewContainer.removeClass("d-none"); // Show the preview container
                    previewImage.attr("src", e.target.result); // Set the image source to the selected file
                };
                reader.readAsDataURL(file); // Read the file as a data URL
            } else {
                // If no file is selected, hide the preview container and clear the image source
                previewContainer.addClass("d-none");
                previewImage.attr("src", "#");
            }
        });

        // List the data based on the product categories
        var catId = `[[${product.categoryId}]]`;
        if (catId) {
            $.ajax({
                url: "variant/categories/" + catId,
                beforeSend: () => { },
                success: function (apiResponse) {
                    $("#myVariantId").empty()
                    $.each(
                        apiResponse,
                        function (idx, value) {
                            $("#myVariantId").append(`<option value="${value.id}">${value.name}</option>`)
                        }
                    )
                    setTimeout(() => {
                        const selectedVariantId = $("#myVariantId").attr("data-selected");
                        console.log("Pre-selected variant ID:", selectedVariantId);

                        if (selectedVariantId) {
                            $("#myVariantId").val(selectedVariantId);
                            console.log("Selected variant ID set to:", selectedVariantId);
                        }
                    }, 100);
                }
            })
        }


        // validate
        $("#frmEditProduct").validate({
            rules: {
                name: {
                    required: true,
                    minlength: 3
                },
                description: {
                    required: true,
                    maxlength: 255
                },
                price: {
                    required: true,
                    minlength: 1
                },
                stock: {
                    required: true,
                    minlength: 1
                },
                variantId: {
                    required: true
                }
            },
            messages: {
                name: {
                    minlength: "Product Name must be at least 3 character long",
                    maxlength: "Product Name maximum at 100 character long",
                    required: "Product Name is required"
                },
                myImage: "Product Image is required",
                description: "Product Description is required",
                price: {
                    min: "Product Price cannot contain negative value",
                    required: "Product Price is required"
                },
                stock: {
                    min: "Product Stock cannot contain negative value",
                    required: "Product Stock is required"
                },
                variantId: {
                    required: "Product VariantId is required"
                }
            },
            errorClass: "text-danger mt-1"
        })

        $("#frmEditProduct").submit(function (e) {
            e.preventDefault()
            if ($("#frmEditProduct").valid()) {
                var formData = new FormData(this)
                formData.append("id", `[[${product.id}]]`);
                $.ajax({
                    url: "product/update",
                    method: "post",
                    data: formData,
                    contentType: false,
                    processData: false,
                    beforeSend: function () {
                        alert("Updating the product.....")
                    },
                    success: function (response) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: `Product name ${response.name} successfully edited!`,
                            confirmButtonText: 'OK'
                        }).then(() => {
                            location.reload();
                        });
                    },
                    error: function (errResponse) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: `Error updating product: ${errResponse.responseText}`,
                            confirmButtonText: 'OK'
                        }).then(() => {
                            location.reload()
                        });
                    }
                })
            }
        })
    })
</script>